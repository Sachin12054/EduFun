// Firebase Firestore Security Rules for EduFun App
// Copy this to Firebase Console → Firestore Database → Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is accessing their own data
    function isOwner(studentId) {
      return isSignedIn() && request.auth.uid == studentId;
    }
    
    // ==================== STUDENTS COLLECTION ====================
    
    // Students can only access their own data
    match /Students/{studentId} {
      // Allow read/write only if the authenticated user matches the studentId
      allow read: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isOwner(studentId);
      allow delete: if false; // Prevent deletion for safety
      
      // ==================== PROFILE SUBCOLLECTION ====================
      match /Profile/{document=**} {
        allow read: if isOwner(studentId);
        allow write: if isOwner(studentId);
        allow delete: if false;
      }
      
      // ==================== PROGRESS SUBCOLLECTION ====================
      match /Progress/{document=**} {
        allow read: if isOwner(studentId);
        allow write: if isOwner(studentId);
        allow delete: if false;
      }
      
      // ==================== LEARNING HISTORY SUBCOLLECTION ====================
      match /LearningHistory/{activityId} {
        allow read: if isOwner(studentId);
        allow create: if isOwner(studentId);
        allow update: if isOwner(studentId);
        allow delete: if false; // Keep history permanent
      }
      
      // ==================== COIN TRANSACTIONS SUBCOLLECTION ====================
      match /CoinTransactions/{transactionId} {
        allow read: if isOwner(studentId);
        allow create: if isOwner(studentId);
        allow update: if false; // Transactions are immutable
        allow delete: if false; // Transactions cannot be deleted
      }
    }
    
    // ==================== LEADERBOARD COLLECTION ====================
    
    // Leaderboard is readable by all authenticated users
    // Only the student can write their own entry
    match /Leaderboard/{grade}/Students/{studentId} {
      allow read: if isSignedIn();
      allow write: if isOwner(studentId);
      allow delete: if false;
    }
    
    // ==================== ADMIN ACCESS (Optional) ====================
    
    // If you want to add admin functionality later, uncomment below
    // Helper function to check if user is admin
    // function isAdmin() {
    //   return isSignedIn() && 
    //          exists(/databases/$(database)/documents/Admins/$(request.auth.uid));
    // }
    
    // Admin collection (only admins can access)
    // match /Admins/{adminId} {
    //   allow read, write: if isAdmin();
    // }
    
    // Admins can read all student data but not modify
    // match /Students/{studentId} {
    //   allow read: if isAdmin();
    //   // Write permissions remain with individual students only
    // }
    
  }
}

// ==================== NOTES ====================
// 
// 1. These rules ensure:
//    - Students can only access their OWN data
//    - No student can view another student's data
//    - Leaderboard is visible to all but only modifiable by owner
//    - All data requires authentication
//    - Deletion is prevented to maintain data integrity
//
// 2. Security Features:
//    - Authentication required for all operations
//    - User ID validation
//    - Immutable transactions
//    - Permanent history logs
//
// 3. To Deploy:
//    - Go to Firebase Console
//    - Select your project
//    - Navigate to Firestore Database → Rules
//    - Copy and paste these rules
//    - Click "Publish"
//
// 4. Testing:
//    - Use Firebase Emulator for local testing
//    - Test with different user accounts
//    - Verify access restrictions work correctly
//
// ==================== END ====================
